<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Comparison Tool</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; margin: 20px 0; text-align: center; }
        .preview { max-width: 200px; margin: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .results { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        .confidence { font-size: 2em; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <h1>üîç Image Comparison Tool</h1>
    <p>Upload two images to check if the first can be extracted from the second using OpenCV</p>
    
    <div class="upload-area">
        <h3>Template Image (to search for)</h3>
        <input type="file" id="template-input" accept="image/*">
        <img id="template-preview" class="preview" style="display: none;">
    </div>
    
    <div class="upload-area">
        <h3>Search Image (to search within)</h3>
        <input type="file" id="search-input" accept="image/*">
        <img id="search-preview" class="preview" style="display: none;">
    </div>
    
    <button id="compare-btn" onclick="compareImages()" disabled>üîç Compare Images</button>
    
    <div id="loading" style="display: none;">Analyzing images...</div>
    
    <div id="results" class="results" style="display: none;">
        <h2>Results</h2>
        <div class="confidence" id="confidence-score">0.000</div>
        <p>Confidence Score</p>
        <div id="match-quality"></div>
        <div id="confidence-explanation" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
        <p><strong>Template Size:</strong> <span id="template-size">-</span></p>
        <p><strong>Search Image Size:</strong> <span id="search-size">-</span></p>
        <p><strong>Match Location:</strong> <span id="match-location">-</span></p>
        <img id="annotated-image" style="max-width: 100%; margin-top: 20px; display: none;">
    </div>

    <script>
        let templateFile = null;
        let searchFile = null;

        document.getElementById('template-input').addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0], 'template');
        });

        document.getElementById('search-input').addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0], 'search');
        });

        function handleFileSelect(file, type) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const preview = document.getElementById(`${type}-preview`);
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                if (type === 'template') {
                    templateFile = file;
                } else {
                    searchFile = file;
                }
                
                document.getElementById('compare-btn').disabled = !(templateFile && searchFile);
            };
        }

        function compareImages() {
            if (!templateFile || !searchFile) {
                alert('Please select both images before comparing.');
                return;
            }

            const formData = new FormData();
            formData.append('template_image', templateFile);
            formData.append('search_image', searchFile);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('compare-btn').disabled = true;

            fetch('/compare', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('compare-btn').disabled = false;

                if (data.success) {
                    displayResults(data);
                } else {
                    alert(data.error || 'Comparison failed. Please try again.');
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('compare-btn').disabled = false;
                alert('Network error. Please try again.');
                console.error('Error:', error);
            });
        }

                function displayResults(data) {
            document.getElementById('confidence-score').textContent = data.confidence.toFixed(3);
            document.getElementById('match-quality').textContent = data.match_quality;
            document.getElementById('template-size').textContent = `${data.template_size[0]} √ó ${data.template_size[1]}`;
            document.getElementById('search-size').textContent = `${data.search_image_size[0]} √ó ${data.search_image_size[1]}`;
            document.getElementById('match-location').textContent = `(${data.match_location[0]}, ${data.match_location[1]})`;

            // Add confidence explanation
            const explanation = getConfidenceExplanation(data.confidence, data.match_quality);
            document.getElementById('confidence-explanation').textContent = explanation;

            if (data.annotated_image) {
                const annotatedImg = document.getElementById('annotated-image');
                annotatedImg.src = `/uploads/${data.annotated_image}`;
                annotatedImg.style.display = 'block';
            }

            document.getElementById('results').style.display = 'block';
        }

        function getConfidenceExplanation(confidence, matchQuality) {
            if (confidence >= 0.99) {
                return "üéØ Perfect match! These images are virtually identical.";
            } else if (confidence >= 0.8) {
                return "‚ú® Excellent match! Very high similarity detected.";
            } else if (confidence >= 0.6) {
                return "üëç Good match! Significant similarity found.";
            } else if (confidence >= 0.4) {
                return "ü§î Moderate match. Some similarity detected.";
            } else if (confidence >= 0.2) {
                return "‚ö†Ô∏è Weak match. Limited similarity found.";
            } else {
                return "‚ùå No significant match detected.";
            }
        }
    </script>
</body>
</html>
